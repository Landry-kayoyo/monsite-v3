<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body>from <a href="http://django.http">django.http</a> import HttpResponse<br>from <a href="http://django.shortcuts">django.shortcuts</a> import get_object_or_<a href="tel:404">404</a><br>from <a href="http://django.contrib.auth.decorators">django.contrib.auth.decorators</a> import login_required<br>from <a href="http://reportlab.pdfgen">reportlab.pdfgen</a> import canvas<br>from <a href="http://reportlab.lib.pagesizes">reportlab.lib.pagesizes</a> import A4<br>from <a href="http://reportlab.lib.units">reportlab.lib.units</a> import cm<br>from <a href="http://reportlab.platypus">reportlab.platypus</a> import Table, TableStyle<br>from <a href="http://reportlab.lib">reportlab.lib</a> import colors<br>from <a href="http://reportlab.lib.utils">reportlab.lib.utils</a> import ImageReader<br>from datetime import datetime<br>import os<br>import io<br>import qrcode<br>from <a href="http://django.conf">django.conf</a> import settings<br>from .models import Eleve, Note<br>@login_required<br>def bulletin_pdf(request, eleve_id):<br>&nbsp;&nbsp;&nbsp; eleve = get_object_or_<a href="tel:404">404</a>(Eleve, pk=eleve_id)<br>&nbsp;&nbsp;&nbsp; notes = <a href="http://Note.objects.filter">Note.objects.filter</a>(eleve=eleve)<br>&nbsp;&nbsp;&nbsp; total_general = sum(<a href="http://n.total">n.total</a> for n in notes)<br>&nbsp;&nbsp;&nbsp; nb_matieres = <a href="http://notes.count">notes.count</a>()<br>&nbsp;&nbsp;&nbsp; moyenne = round(total_general / nb_matieres, 2) if nb_matieres else 0<br>&nbsp;&nbsp;&nbsp; if moyenne &gt;= 16:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mention = "Très Bien"<br>&nbsp;&nbsp;&nbsp; elif moyenne &gt;= 14:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mention = "Bien"<br>&nbsp;&nbsp;&nbsp; elif moyenne &gt;= 12:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mention = "Assez Bien"<br>&nbsp;&nbsp;&nbsp; elif moyenne &gt;= 10:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mention = "Passable"<br>&nbsp;&nbsp;&nbsp; else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mention = "Échec"<br>&nbsp;&nbsp;&nbsp; decision = "Admis" if moyenne &gt;= 10 else "Ajourné"<br>&nbsp;&nbsp;&nbsp; date_du_jour = <a href="http://datetime.now">datetime.now</a>().strftime("%d/%m/%Y")<br>&nbsp;&nbsp;&nbsp; response = HttpResponse(content_type='application/pdf')<br>&nbsp;&nbsp;&nbsp; response['Content-Disposition'] = f'attachment; filename="bulletin_{<a href="http://eleve.matricule">eleve.matricule</a>}.pdf"'<br>&nbsp;&nbsp;&nbsp; p = <a href="http://canvas.Canvas">canvas.Canvas</a>(response, pagesize=A4)<br>&nbsp;&nbsp;&nbsp; width, height = A4<br>&nbsp;&nbsp;&nbsp; # === EN-TÊTE ===<br>&nbsp;&nbsp;&nbsp; logo_path = <a href="http://os.path.join">os.path.join</a>(settings.BASE_DIR, "gestion", "static", "images", "<a href="http://logo.png">logo.png</a>")<br>&nbsp;&nbsp;&nbsp; if <a href="http://os.path.exists">os.path.exists</a>(logo_path):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://p.drawImage">p.drawImage</a>(logo_path, 2*cm, height - 4*cm, width=3*cm, height=3*cm, mask='auto')<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Bold", 16)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawCentredString">p.drawCentredString</a>(width / 2, height - 2 * cm, "ÉCOLE SUPÉRIEURE EXCELLENCE")<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Oblique", 10)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawCentredString">p.drawCentredString</a>(width / 2, height - <a href="tel:2.7">2.7</a> * cm, "Former l'élite de demain")<br>&nbsp;&nbsp;&nbsp; # Ligne décorative<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setStrokeColor">p.setStrokeColor</a>(<a href="http://colors.blue">colors.blue</a>)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setLineWidth">p.setLineWidth</a>(2)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.line">p.line</a>(2*cm, height - <a href="tel:3.2">3.2</a>*cm, width - 2*cm, height - <a href="tel:3.2">3.2</a>*cm)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Bold", 18)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawCentredString">p.drawCentredString</a>(width / 2, height - <a href="tel:4.3">4.3</a> * cm, "RELEVÉ OFFICIEL DES RÉSULTATS")<br>&nbsp;&nbsp;&nbsp; # Bloc infos élève<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setLineWidth">p.setLineWidth</a>(1)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setStrokeColor">p.setStrokeColor</a>(<a href="http://colors.black">colors.black</a>)<br>&nbsp;&nbsp;&nbsp; bloc_top = height - <a href="tel:5.5">5.5</a> * cm<br>&nbsp;&nbsp;&nbsp; bloc_left = 2 * cm<br>&nbsp;&nbsp;&nbsp; bloc_width = width - 4 * cm<br>&nbsp;&nbsp;&nbsp; bloc_height = 3 * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.rect">p.rect</a>(bloc_left, bloc_top - bloc_height, bloc_width, bloc_height)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica", 11)<br>&nbsp;&nbsp;&nbsp; y_info = bloc_top - <a href="tel:0.7">0.7</a> * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(bloc_left + <a href="tel:0.5">0.5</a>*cm, y_info, f"Nom complet : {<a href="http://eleve.nom">eleve.nom</a>} {<a href="http://eleve.postnom">eleve.postnom</a>}")<br>&nbsp;&nbsp;&nbsp; y_info -= <a href="tel:0.7">0.7</a> * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(bloc_left + <a href="tel:0.5">0.5</a>*cm, y_info, f"Matricule : {<a href="http://eleve.matricule">eleve.matricule</a>}")<br>&nbsp;&nbsp;&nbsp; y_info -= <a href="tel:0.7">0.7</a> * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(bloc_left + <a href="tel:0.5">0.5</a>*cm, y_info, f"Classe : {<a href="http://eleve.classe">eleve.classe</a>}")<br>&nbsp;&nbsp;&nbsp; # === TABLEAU DES NOTES ===<br>&nbsp;&nbsp;&nbsp; y = bloc_top - bloc_height - 1 * cm<br>&nbsp;&nbsp;&nbsp; data = [["Matière", "Interro/10", "Exam/10", "TD/5", "TP/5", "Total/20"]]<br>&nbsp;&nbsp;&nbsp; for note in notes:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://data.append">data.append</a>([<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.matiere.nom">note.matiere.nom</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.interrogation">note.interrogation</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.exam">note.exam</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.td">note.td</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.tp">note.tp</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://note.total">note.total</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ])<br>&nbsp;&nbsp;&nbsp; <a href="http://data.append">data.append</a>(["", "", "", "", "Moyenne", moyenne])<br>&nbsp;&nbsp;&nbsp; table = Table(data, colWidths=[5*cm, 2*cm, 2*cm, 2*cm, 2*cm, 2*cm])<br>&nbsp;&nbsp;&nbsp; <a href="http://table.setStyle">table.setStyle</a>(TableStyle([<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('BACKGROUND', (0, 0), (-1, 0), <a href="http://colors.darkblue">colors.darkblue</a>),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('TEXTCOLOR', (0, 0), (-1, 0), <a href="http://colors.whitesmoke">colors.whitesmoke</a>),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('ALIGN', (0, 0), (-1, -1), 'CENTER'),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('FONT', (0, 0), (-1, 0), 'Helvetica-Bold'),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('GRID', (0, 0), (-1, -1), <a href="tel:0.5">0.5</a>, <a href="http://colors.black">colors.black</a>),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ('BACKGROUND', (0, -1), (-1, -1), <a href="http://colors.lightblue">colors.lightblue</a>),<br>&nbsp;&nbsp;&nbsp; ]))<br>&nbsp;&nbsp;&nbsp; table_height = len(data)*<a href="tel:0.6">0.6</a>*cm<br>&nbsp;&nbsp;&nbsp; <a href="http://table.wrapOn">table.wrapOn</a>(p, width, height)<br>&nbsp;&nbsp;&nbsp; <a href="http://table.drawOn">table.drawOn</a>(p, 2 * cm, y - table_height)<br>&nbsp;&nbsp;&nbsp; y = y - table_height - 1 * cm<br>&nbsp;&nbsp;&nbsp; # Mention et Décision<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Bold", 12)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(2 * cm, y, f"Mention : {mention}")<br>&nbsp;&nbsp;&nbsp; y -= <a href="tel:0.6">0.6</a> * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(2 * cm, y, f"Décision : {decision}")<br>&nbsp;&nbsp;&nbsp; # === CADRE SIGNATURE ===<br>&nbsp;&nbsp;&nbsp; y -= 2 * cm<br>&nbsp;&nbsp;&nbsp; cadre_x = width - 8 * cm<br>&nbsp;&nbsp;&nbsp; cadre_y = y - <a href="tel:3.5">3.5</a> * cm<br>&nbsp;&nbsp;&nbsp; cadre_w = <a href="tel:6.5">6.5</a> * cm<br>&nbsp;&nbsp;&nbsp; cadre_h = 3 * cm<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setLineWidth">p.setLineWidth</a>(1)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setStrokeColor">p.setStrokeColor</a>(<a href="http://colors.black">colors.black</a>)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.rect">p.rect</a>(cadre_x, cadre_y, cadre_w, cadre_h)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica", 10)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(cadre_x + <a href="tel:0.5">0.5</a>*cm, cadre_y + cadre_h - <a href="tel:0.8">0.8</a>*cm,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Fait à Lubumbashi, le {date_du_jour}")<br>&nbsp;&nbsp;&nbsp; signature_path = <a href="http://os.path.join">os.path.join</a>(settings.BASE_DIR, "gestion", "static", "images", "<a href="http://signature.png">signature.png</a>")<br>&nbsp;&nbsp;&nbsp; if <a href="http://os.path.exists">os.path.exists</a>(signature_path):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://p.drawImage">p.drawImage</a>(signature_path, cadre_x + <a href="tel:0.5">0.5</a>*cm, cadre_y + <a href="tel:0.5">0.5</a>*cm,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; width=5*cm, height=<a href="tel:1.5">1.5</a>*cm, mask='auto')<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Bold", 10)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawString">p.drawString</a>(cadre_x + <a href="tel:0.5">0.5</a>*cm, cadre_y + <a href="tel:0.3">0.3</a>*cm, "Pr. Jean KABUYA – Directeur")<br>&nbsp;&nbsp;&nbsp; # === QR CODE ===<br>&nbsp;&nbsp;&nbsp; qr_data = (<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Nom complet: {<a href="http://eleve.nom">eleve.nom</a>} {<a href="http://eleve.postnom">eleve.postnom</a>}\n"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Matricule: {<a href="http://eleve.matricule">eleve.matricule</a>}\n"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Classe: {<a href="http://eleve.classe">eleve.classe</a>}\n"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Généré le: {date_du_jour}"<br>&nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; qr_img = <a href="http://qrcode.make">qrcode.make</a>(qr_data)<br>&nbsp;&nbsp;&nbsp; img_buffer = <a href="http://io.BytesIO">io.BytesIO</a>()<br>&nbsp;&nbsp;&nbsp; <a href="http://qr_img.save">qr_img.save</a>(img_buffer, format='PNG')<br>&nbsp;&nbsp;&nbsp; <a href="http://img_buffer.seek">img_buffer.seek</a>(0)<br>&nbsp;&nbsp;&nbsp; qr_image_reader = ImageReader(img_buffer)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawImage">p.drawImage</a>(qr_image_reader, 2*cm, <a href="tel:2.5">2.5</a>*cm, width=4*cm, height=4*cm, mask='auto')<br>&nbsp;&nbsp;&nbsp; # Pied de page<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setStrokeColor">p.setStrokeColor</a>(<a href="http://colors.grey">colors.grey</a>)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setLineWidth">p.setLineWidth</a>(1)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.line">p.line</a>(2*cm, 2*cm, width - 2*cm, 2*cm)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFont">p.setFont</a>("Helvetica-Oblique", 8)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.setFillColor">p.setFillColor</a>(<a href="http://colors.grey">colors.grey</a>)<br>&nbsp;&nbsp;&nbsp; <a href="http://p.drawRightString">p.drawRightString</a>(width - 2*cm, <a href="tel:1.5">1.5</a>*cm,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"Bulletin généré automatiquement le {date_du_jour} – Page 1/1")<br>&nbsp;&nbsp;&nbsp; <a href="http://p.showPage">p.showPage</a>()<br>&nbsp;&nbsp;&nbsp; <a href="http://p.save">p.save</a>()<br>&nbsp;&nbsp;&nbsp; return response</body></html>